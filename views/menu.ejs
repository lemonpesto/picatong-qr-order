<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë©”ë‰´íŒ</title>
    <link rel="stylesheet" href="/main.css" />
    <script src="https://kit.fontawesome.com/a3ff865f92.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <%- include("nav.ejs") %>

    <!-- ì¹´í…Œê³ ë¦¬ ëª©ì°¨ -->
    <div class="category-bar">
      <% categories.forEach(cat => { %>
      <button class="category-button" data-target="section-<%= cat.name %>"><%= cat.name %></button>
      <% }) %>
    </div>

    <!-- ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ -->
    <% categories.forEach((cat, i) => { %>
    <div id="section-<%= cat.name %>" class="menu-section">
      <h3><%= cat.name %></h3>
      <% const filtered = menus.filter(m => m.category === cat.name); filtered.forEach((menu, j) => { const soldOut = !menu.isActive; %>
      <div
        class="list-box<%= soldOut ? ' sold-out' : '' %>"
        data-menuid="<%= menu._id %>"
        data-name="<%= menu.name %>"
        data-price="<%= menu.price %>"
      >
        <h4><%= soldOut ? `(í’ˆì ˆ) ${menu.name}` : menu.name %></h4>
        <p class="price"><%= menu.price.toLocaleString() %>ì›</p>
        <p class="description"><%= menu.description || '' %></p>
      </div>
      <!-- <% if (j < filtered.length) { %> -->
      <div class="menu-divider"></div>
      <!-- <% } %> -->
      <% }) %>
    </div>
    <% if (i < categories.length - 1) { %>
    <div class="section-divider"></div>
    <% } %> <% }) %>

    <!-- ì¥ë°”êµ¬ë‹ˆ ë³´ê¸° ë²„íŠ¼ -->
    <div class="bottom-bar">
      <a href="/cart" id="view-cart" class="bottom-button hidden">ì¥ë°”êµ¬ë‹ˆ ë³´ê¸°</a>
    </div>

    <!-- ë°”í…€ ì‹œíŠ¸ -->
    <div id="bottom-sheet" class="bottom-sheet hidden">
      <div class="bottom-sheet-content">
        <div class="sheet-header">
          <h4 id="sheet-name">ë©”ë‰´ëª…</h4>
          <button id="close-sheet">âœ•</button>
        </div>
        <div class="sheet-subheader">
          <span id="sheet-price">ë‹¨ê°€</span>
        </div>
        <div class="sheet-qty-row">
          <span class="qty-label">ìˆ˜ëŸ‰</span>
          <div class="qty-control">
            <button id="minus" class="qty-btn" disabled>
              <i class="fa-solid fa-minus fa-2xs"></i>
            </button>
            <span id="qty" class="qty">1</span>
            <button id="plus" class="qty-btn">
              <i class="fa-solid fa-plus fa-2xs"></i>
            </button>
          </div>
        </div>
        <button id="add-to-cart" class="cart-button">0ì› ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°</button>
      </div>
    </div>

    <div id="toast" class="toast-msg"></div>
    <div id="overlay" class="overlay hidden"></div>

    <script>
      window.addEventListener('resize', () => {
        const bar = document.querySelector('.bottom-bar');
        bar.style.position = document.body.scrollHeight > window.innerHeight ? 'sticky' : 'fixed';
      });
    </script>
    <script src="/menu-category.js"></script>
    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        let currPrice = 0;
        let currMenuId = null;
        let qty = 1;
        // utility: ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ í…ìŠ¤íŠ¸ ê°±ì‹ 
        function updateAddToCartButton(qty) {
          const total = currPrice * qty;
          const button = document.getElementById('add-to-cart');
          button.textContent = `${total.toLocaleString()}ì› ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°`;
        }

        window.addEventListener('DOMContentLoaded', () => {
          updateCartButton();
        });

        // ì†Œì¼“ ì´ë²¤íŠ¸
        socket.on('menuUpdated', updateExistingMenu);
        socket.on('menuAdded', addNewMenu);
        socket.on('menuDeleted', deleteMenuBox);

        function attachBoxListener(box) {
          box.addEventListener('click', () => {
            if (box.classList.contains('sold-out')) return;
            openBottomSheet(box);
          });
        }

        // ê¸°ì¡´ ë°•ìŠ¤ ì´ˆê¸°í™”
        document.querySelectorAll('.list-box').forEach(attachBoxListener);

        // ë°”í…€ ì‹œíŠ¸ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        document.getElementById('plus').addEventListener('click', () => {
          qty++;
          document.getElementById('qty').textContent = qty;
          document.getElementById('minus').disabled = false;
          updateAddToCartButton(qty);
        });
        document.getElementById('minus').addEventListener('click', () => {
          if (qty > 1) qty--;
          document.getElementById('qty').textContent = qty;
          document.getElementById('minus').disabled = qty === 1;
          updateAddToCartButton(qty);
        });

        // document.getElementById('plus').addEventListener('click', () => {
        //   let qty = parseInt(document.getElementById('qty').textContent);
        //   document.getElementById('qty').textContent = ++qty;
        //   document.getElementById('minus').disabled = qty === 1;
        //   updateAddToCartButton(qty);
        // });

        // document.getElementById('minus').addEventListener('click', () => {
        //   let qty = parseInt(document.getElementById('qty').textContent);
        //   if (qty > 1) {
        //     document.getElementById('qty').textContent = --qty;
        //     document.getElementById('minus').disabled = qty === 1;
        //     updateAddToCartButton(qty);
        //   }
        // });

        document.getElementById('add-to-cart').addEventListener('click', async () => {
          const name = document.getElementById('sheet-name').textContent;
          const qty = document.getElementById('qty').textContent;
          try {
            const res = await fetch(`/cart/add?menuid=${currMenuId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name,
                price: currPrice,
                qty,
              }),
            });
            if (!res.ok) {
              const msg = await res.text();
              throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + msg);
            }
            await updateCartButton();

            const msg = await res.text();
            showToast(msg); // ì˜ˆ: "ë©”ë‰´ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤."
          } catch (err) {
            console.error('ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì‹¤íŒ¨:', err);
            showToast('ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš” ğŸ˜¢');
          }
          // ë°”í…€ ì‹œíŠ¸ ë‹«ê¸°
          closeBottomSheet();
        });

        document.getElementById('close-sheet').addEventListener('click', closeBottomSheet);
        document.getElementById('overlay').addEventListener('click', closeBottomSheet);

        // socket.on('menuDeleted', (id) => {
        //   const box = document.querySelector(`.list-box[data-menuid="${id}"]`);
        //   if (!box) return;
        //   // êµ¬ë¶„ì„ (divider)ë„ í•¨ê»˜ ì œê±°
        //   const next = box.nextElementSibling;
        //   box.remove();
        //   if (next && next.classList.contains('menu-divider')) {
        //     next.remove();
        //   }
        // });

        // // 1) ì†Œì¼“ ì´ë²¤íŠ¸
        // socket.on('menuUpdated', (menu) => {
        //   // 1) ê¸°ì¡´ ë°•ìŠ¤ ì°¾ê¸°
        //   const box = document.querySelector(`.list-box[data-menuid="${menu._id}"]`);
        //   if (!box) return;

        //   // 2) íŒë§¤ ì—¬ë¶€ (sold-out í´ë˜ìŠ¤ í† ê¸€ & ì´ë¦„ ì•ì ‘ì‚¬)
        //   const soldOut = !menu.isActive;
        //   box.classList.toggle('sold-out', soldOut);

        //   // 3) ë°ì´í„° ì†ì„± ì—…ë°ì´íŠ¸
        //   box.dataset.name = menu.name;
        //   box.dataset.price = menu.price;

        //   // 4) ë‚´ë¶€ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        //   box.querySelector('h4').textContent = soldOut ? `(í’ˆì ˆ) ${menu.name}` : menu.name;

        //   box.querySelector('.price').textContent = `${menu.price.toLocaleString()}ì›`;

        //   box.querySelector('.description').textContent = menu.description || '';

        //   // 5) ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ ì´ë™ (ì˜µì…˜)
        //   const currentSection = box.closest('.menu-section');
        //   const targetSection = document.getElementById(`section-${menu.category}`);
        //   if (currentSection !== targetSection && targetSection) {
        //     // ê¸°ì¡´ ë°•ìŠ¤ì™€ êµ¬ë¶„ì„  ì œê±°
        //     const nextDivider = box.nextElementSibling;
        //     box.remove();
        //     if (nextDivider && nextDivider.classList.contains('menu-divider')) {
        //       nextDivider.remove();
        //     }
        //     // ìƒˆ ì„¹ì…˜ì— ë‹¤ì‹œ ì¶”ê°€ (ë§ˆì§€ë§‰ì—)
        //     // const divider = document.createElement('div');
        //     // divider.className = 'menu-divider';
        //     targetSection.append(box);
        //   }
        // });
        // socket.on('menuAdded', (menu) => {
        //   const section = document.getElementById(`section-${menu.category}`);
        //   if (!section) return;
        //   // ìƒˆ ë°•ìŠ¤ ìƒì„±
        //   const box = document.createElement('div');
        //   box.className = 'list-box';
        //   box.dataset.menuid = menu._id;
        //   box.dataset.name = menu.name;
        //   box.dataset.price = menu.price;
        //   if (!menu.isActive) box.classList.add('sold-out');
        //   box.innerHTML = `
        //     <h4>${menu.isActive ? menu.name : `(í’ˆì ˆ) ${menu.name}`}</h4>
        //     <p class="price">${menu.price.toLocaleString()}ì›</p>
        //     <p class="description">${menu.description || ''}</p>
        //   `;
        //   attachBoxListener(box);
        //   // êµ¬ë¶„ì„  ë’¤ì— ì¶”ê°€
        //   const divider = document.createElement('div');
        //   divider.className = 'menu-divider';
        //   // 3) ê¸°ì¡´ ë©”ë‰´ê°€ ìˆìœ¼ë©´ divider â†’ box, ì—†ìœ¼ë©´ boxë§Œ
        //   const hasExisting = section.querySelector('.list-box') !== null;
        //   if (hasExisting) {
        //     section.append(divider, box);
        //   } else {
        //     section.append(box);
        //   }
        // });

        // ========= í•¨ìˆ˜ ì •ì˜ë“¤ ========= //

        // function closeBottomSheet() {
        //   document.getElementById('bottom-sheet').classList.remove('show');
        //   document.getElementById('bottom-sheet').classList.add('hidden');
        //   document.getElementById('overlay').classList.add('hidden');
        // }
        function closeBottomSheet() {
          document.getElementById('bottom-sheet').classList.add('hidden');
          document.getElementById('overlay').classList.add('hidden');
        }

        // document.querySelectorAll('.list-box').forEach((item) => {
        //   item.addEventListener('click', () => {
        //     const name = item.dataset.name;
        //     const price = parseInt(item.dataset.price);
        //     const menuId = item.dataset.menuid;

        //     currPrice = price; // í˜„ì¬ ë©”ë‰´ ë‹¨ê°€ ê¸°ì–µ
        //     currMenuId = menuId;

        //     // ë°”í…€ ì‹œíŠ¸ ìš”ì†Œë“¤ ì„¤ì •
        //     document.getElementById('sheet-name').textContent = name;
        //     document.getElementById('qty').textContent = '1';
        //     document.getElementById('sheet-price').textContent = price.toLocaleString() + 'ì›';
        //     document.getElementById('minus').disabled = true; // ì´ˆê¸° ìˆ˜ëŸ‰ 1ì´ë¯€ë¡œ - ë²„íŠ¼ ë¹„í™œì„±í™”

        //     // ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
        //     updateAddToCartButton(1);

        //     // ë°”í…€ ì‹œíŠ¸, ì˜¤ë²„ë ˆì´ ë³´ì´ê¸°
        //     document.getElementById('bottom-sheet').classList.remove('hidden');
        //     document.getElementById('bottom-sheet').classList.add('show');
        //     document.getElementById('overlay').classList.remove('hidden');
        //   });
        // });

        function openBottomSheet(box) {
          currMenuId = box.dataset.menuid;
          currPrice = parseInt(box.dataset.price);
          qty = 1;

          // ë°”í…€ ì‹œíŠ¸ ìš”ì†Œë“¤ ì´ˆê¸°í™”
          document.getElementById('sheet-name').textContent = box.dataset.name;
          document.getElementById('qty').textContent = '1';
          document.getElementById('sheet-price').textContent = currPrice.toLocaleString() + 'ì›';
          document.getElementById('minus').disabled = true;

          // ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
          updateAddToCartButton(1);

          // ë°”í…€ ì‹œíŠ¸, ì˜¤ë²„ë ˆì´ ë³´ì´ê¸°
          document.getElementById('bottom-sheet').classList.remove('hidden');
          document.getElementById('overlay').classList.remove('hidden');
        }

        function updateExistingMenu(menu) {
          const box = document.querySelector(`.list-box[data-menuid="${menu._id}"]`);
          if (!box) return;
          const soldOut = !menu.isActive;
          box.classList.toggle('sold-out', soldOut);
          box.dataset.name = menu.name;
          box.dataset.price = menu.price;
          box.querySelector('h4').textContent = soldOut ? `(í’ˆì ˆ) ${menu.name}` : menu.name;
          box.querySelector('.price').textContent = `${menu.price.toLocaleString()}ì›`;
          box.querySelector('.description').textContent = menu.description || '';
        }
        function addNewMenu(menu) {
          const section = document.getElementById(`section-${menu.category}`);
          if (!section) return;
          const box = document.createElement('div');
          box.className = 'list-box';
          if (!menu.isActive) box.classList.add('sold-out');
          box.dataset.menuid = menu._id;
          box.dataset.name = menu.name;
          box.dataset.price = menu.price;
          box.innerHTML = `
            <h4>${menu.isActive ? menu.name : `(í’ˆì ˆ) ${menu.name}`}</h4>
            <p class="price">${menu.price.toLocaleString()}ì›</p>
            <p class="description">${menu.description || ''}</p>
          `;
          attachBoxListener(box);
          const divider = document.createElement('div');
          divider.className = 'menu-divider';
          const hasExisting = section.querySelector('.list-box') !== null;
          hasExisting ? section.append(divider, box) : section.append(box);
        }
        function deleteMenuBox(id) {
          const box = document.querySelector(`.list-box[data-menuid="${id}"]`);
          if (!box) return;
          const next = box.nextElementSibling;
          box.remove();
          if (next && next.classList.contains('menu-divider')) next.remove();
        }

        function showToast(msg) {
          const t = document.getElementById('toast');
          t.textContent = msg;
          t.classList.add('show');
          setTimeout(() => t.classList.remove('show'), 2000);
        }
        async function updateCartButton() {
          try {
            const res = await fetch('/cart/summary');
            const data = await res.json(); // { total: 12000, count: 3 }

            const viewCart = document.getElementById('view-cart');
            if (data.count > 0) {
              viewCart.textContent = `ì´ ${data.total.toLocaleString()}ì› ì¥ë°”êµ¬ë‹ˆ ë³´ê¸° (${data.count})`;
              viewCart.classList.remove('hidden');
            } else {
              viewCart.classList.add('hidden');
            }
          } catch (err) {
            console.error('ì¥ë°”êµ¬ë‹ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', err);
          }
        }
      });
    </script>
  </body>
</html>
