<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë©”ë‰´íŒ</title>
    <link rel="stylesheet" href="/main.css" />
    <script src="https://kit.fontawesome.com/a3ff865f92.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <%- include("nav.ejs") %>

    <!-- ì¹´í…Œê³ ë¦¬ ëª©ì°¨ -->
    <div class="category-bar">
      <% categories.forEach(cat => { %>
      <button class="category-button" data-target="section-<%= cat.name %>"><%= cat.name %></button>
      <% }) %>
    </div>

    <!-- ë©”ë‰´ ë¦¬ìŠ¤íŠ¸ -->
    <% categories.forEach((cat, i) => { %>
    <div id="section-<%= cat.name %>" class="menu-section">
      <h3><%= cat.name %></h3>
      <% const filtered = menus.filter(m => m.category === cat.name); filtered.forEach((menu, j) => { const soldOut = !menu.isActive; %>
      <div class="list-box menu-box <%= soldOut ? ' sold-out' : '' %>" data-menuid="<%= menu._id %>" data-name="<%= menu.name %>" data-price="<%= menu.price %>">
        <h4><%= soldOut ? `(í’ˆì ˆ) ${menu.name}` : menu.name %></h4>
        <p class="price"><%= menu.price.toLocaleString() %>ì›</p>
        <p class="description"><%= menu.description || '' %></p>
      </div>
      <% if (j < filtered.length - 1) { %>
      <div class="menu-divider"></div>
      <% } %> <% }) %>
    </div>
    <% if (i < categories.length - 1) { %>
    <div class="section-divider"></div>
    <% } %> <% }) %>

    <!-- ì¥ë°”êµ¬ë‹ˆ ë³´ê¸° ë²„íŠ¼ -->
    <div class="bottom-bar">
      <a href="/cart" id="view-cart" class="bottom-button hidden">ì¥ë°”êµ¬ë‹ˆ ë³´ê¸°</a>
    </div>

    <!-- ë°”í…€ ì‹œíŠ¸ -->
    <div id="bottom-sheet" class="bottom-sheet hidden">
      <div class="bottom-sheet-content">
        <div class="sheet-header">
          <h4 id="sheet-name">ë©”ë‰´ëª…</h4>
          <button id="close-sheet">âœ•</button>
        </div>
        <div class="sheet-subheader">
          <span id="sheet-price">ë‹¨ê°€</span>
        </div>
        <div class="sheet-body">
          <div class="qty-row">
            <span class="qty-label">ìˆ˜ëŸ‰</span>
            <div class="qty-control">
              <button id="minus" class="qty-btn" disabled>
                <i class="fa-solid fa-minus fa-2xs"></i>
              </button>
              <span id="qty" class="qty">1</span>
              <button id="plus" class="qty-btn">
                <i class="fa-solid fa-plus fa-2xs"></i>
              </button>
            </div>
          </div>
          <!-- ìš”ì²­ì‚¬í•­ ì…ë ¥ë€ (ì¹µí…Œì¼ ì˜¤ë§ˆì¹´ì„¸ ë©”ë‰´ë§Œ ë³´ì„) -->
          <div id="comment-row" class="comment-row">
            <label for="sheet-comment">ìš”ì²­ì‚¬í•­</label>
            <input id="sheet-comment" type="text" placeholder="ì˜ˆ: ëœ ë‹¬ê²Œ, ìƒí¼í•˜ê²Œ ë“±" maxlength="50" />
          </div>
        </div>

        <button id="add-to-cart" class="cart-button">0ì› ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°</button>
      </div>
    </div>

    <div id="toast" class="toast-msg"></div>
    <div id="overlay" class="overlay hidden"></div>

    <script>
      window.addEventListener("resize", () => {
        const bar = document.querySelector(".bottom-bar");
        bar.style.position = document.body.scrollHeight > window.innerHeight ? "sticky" : "fixed";
      });
    </script>
    <script src="/toast.js"></script>
    <script src="/menu-category.js"></script>

    <!-- Socket.IO -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const socket = io();
        let currMenuId = null,
          currPrice = 0,
          qty = 1,
          currMenuName = "";

        // utility: ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ í…ìŠ¤íŠ¸ ê°±ì‹ 
        function updateAddToCartButton(qty) {
          const total = currPrice * qty;
          const button = document.getElementById("add-to-cart");
          button.textContent = `${total.toLocaleString()}ì› ì¥ë°”êµ¬ë‹ˆì— ë‹´ê¸°`;
        }

        updateCartButton();

        // ì†Œì¼“ ì´ë²¤íŠ¸
        socket.on("menuUpdated", updateExistingMenu);
        socket.on("menuAdded", addNewMenu);
        socket.on("menuDeleted", deleteMenuBox);

        function attachBoxListener(box) {
          box.addEventListener("click", () => {
            if (box.classList.contains("sold-out")) return;
            openBottomSheet(box);
          });
        }

        // ê¸°ì¡´ ë°•ìŠ¤ ì´ˆê¸°í™”
        document.querySelectorAll(".list-box").forEach(attachBoxListener);

        // ë°”í…€ ì‹œíŠ¸ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        document.getElementById("plus").addEventListener("click", () => {
          qty++;
          document.getElementById("qty").textContent = qty;
          document.getElementById("minus").disabled = false;
          updateAddToCartButton(qty);
        });
        document.getElementById("minus").addEventListener("click", () => {
          if (qty > 1) qty--;
          document.getElementById("qty").textContent = qty;
          document.getElementById("minus").disabled = qty === 1;
          updateAddToCartButton(qty);
        });

        document.getElementById("add-to-cart").addEventListener("click", async () => {
          const name = document.getElementById("sheet-name").textContent;
          const qty = document.getElementById("qty").textContent;
          const comment = document.getElementById("comment-row").style.display !== "none" ? document.getElementById("sheet-comment").value.trim() : null;
          try {
            const res = await fetch(`/cart/add?menuid=${currMenuId}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name,
                price: currPrice,
                qty,
                comment,
              }),
            });
            if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
            await updateCartButton();
            const msg = await res.text();
            showToast(msg); // ì˜ˆ: "ë©”ë‰´ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤."
          } catch (err) {
            showToast("ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš” ğŸ˜¢");
          }
          // ë°”í…€ ì‹œíŠ¸ ë‹«ê¸°
          closeBottomSheet();
        });

        document.getElementById("close-sheet").addEventListener("click", closeBottomSheet);
        document.getElementById("overlay").addEventListener("click", closeBottomSheet);

        function closeBottomSheet() {
          document.getElementById("bottom-sheet").classList.add("hidden");
          document.getElementById("overlay").classList.add("hidden");
        }

        function openBottomSheet(box) {
          currMenuId = box.dataset.menuid;
          currMenuName = box.dataset.name;
          currPrice = parseInt(box.dataset.price);
          qty = 1;

          // ë°”í…€ ì‹œíŠ¸ ìš”ì†Œë“¤ ì´ˆê¸°í™”
          document.getElementById("sheet-name").textContent = box.dataset.name;
          document.getElementById("qty").textContent = "1";
          document.getElementById("sheet-price").textContent = currPrice.toLocaleString() + "ì›";
          document.getElementById("minus").disabled = true;

          // ì˜¤ë§ˆì¹´ì„¸ì¼ ë•Œë§Œ comment ì…ë ¥ë€ ë…¸ì¶œ
          const commentRow = document.getElementById("comment-row");
          const commentInput = document.getElementById("sheet-comment");
          if (currMenuName.includes("ì˜¤ë§ˆì¹´ì„¸")) {
            // ì´ë¦„ìœ¼ë¡œ íŒë³„ (idë‚˜ íƒœê·¸ ì¶”ê°€í•´ë„ OK)
            commentRow.style.display = "";
            commentInput.value = "";
          } else {
            commentRow.style.display = "none";
            commentInput.value = "";
          }

          // ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
          updateAddToCartButton(1);
          // ë°”í…€ ì‹œíŠ¸, ì˜¤ë²„ë ˆì´ ë³´ì´ê¸°
          document.getElementById("bottom-sheet").classList.remove("hidden");
          document.getElementById("overlay").classList.remove("hidden");
        }

        function updateExistingMenu(menu) {
          const box = document.querySelector(`.list-box[data-menuid="${menu._id}"]`);
          if (!box) return;
          const soldOut = !menu.isActive;
          box.classList.toggle("sold-out", soldOut);
          box.dataset.name = menu.name;
          box.dataset.price = menu.price;
          box.querySelector("h4").textContent = soldOut ? `(í’ˆì ˆ) ${menu.name}` : menu.name;
          box.querySelector(".price").textContent = `${menu.price.toLocaleString()}ì›`;
          box.querySelector(".description").textContent = menu.description || "";
        }
        function addNewMenu(menu) {
          const section = document.getElementById(`section-${menu.category}`);
          if (!section) return;
          const box = document.createElement("div");
          box.className = "list-box";
          if (!menu.isActive) box.classList.add("sold-out");
          box.dataset.menuid = menu._id;
          box.dataset.name = menu.name;
          box.dataset.price = menu.price;
          box.innerHTML = `
            <h4>${menu.isActive ? menu.name : `(í’ˆì ˆ) ${menu.name}`}</h4>
            <p class="price">${menu.price.toLocaleString()}ì›</p>
            <p class="description">${menu.description || ""}</p>
          `;
          attachBoxListener(box);
          const divider = document.createElement("div");
          divider.className = "menu-divider";
          const hasExisting = section.querySelector(".list-box") !== null;
          hasExisting ? section.append(divider, box) : section.append(box);
        }
        function deleteMenuBox(id) {
          const box = document.querySelector(`.list-box[data-menuid="${id}"]`);
          if (!box) return;
          const next = box.nextElementSibling;
          box.remove();
          if (next && next.classList.contains("menu-divider")) next.remove();
        }

        function showToast(msg) {
          const t = document.getElementById("toast");
          t.textContent = msg;
          t.classList.add("show");
          setTimeout(() => t.classList.remove("show"), 2000);
        }
        async function updateCartButton() {
          try {
            const res = await fetch("/cart/summary");
            const data = await res.json(); // { total: 12000, count: 3 }

            const viewCart = document.getElementById("view-cart");
            if (data.count > 0) {
              viewCart.textContent = `ì´ ${data.total.toLocaleString()}ì› ì¥ë°”êµ¬ë‹ˆ ë³´ê¸° (${data.count})`;
              viewCart.classList.remove("hidden");
            } else {
              viewCart.classList.add("hidden");
            }
          } catch (err) {
            console.error("ì¥ë°”êµ¬ë‹ˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", err);
          }
        }
      });
    </script>
  </body>
</html>
