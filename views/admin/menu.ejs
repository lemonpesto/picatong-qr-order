<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>피카통 오더</title>
    <link rel="stylesheet" href="/admin.css" />
    <script src="https://kit.fontawesome.com/a3ff865f92.js" crossorigin="anonymous"></script>
    <!-- Sortable.js 로 드래그 앤 드롭 순서 변경 -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  </head>
  <body>
    <%- include('./partial/sidebar') %>
    <!-- 카테고리 탭 -->
    <div class="category-tabs">
      <% categories.forEach((cat, idx) => { %>
      <button class="tab-btn <%= idx===0? 'active': '' %>" data-target="section-<%= cat.name %>"><%= cat.name %></button>
      <% }) %>
    </div>
    <div class="menu-page">
      <!-- 메뉴 카드 그룹 (카테고리별) -->
      <div class="menu-cards">
        <% categories.forEach(cat => { %>
        <section id="section-<%= cat.name %>" class="category-section">
          <h2 class="category-title"><%= cat.name %></h2>
          <div class="cards-wrapper">
            <% menus.filter(m => m.category === cat.name).forEach(menu => { %>
            <div class="menu-card">
              <div class="card-header">
                <h3><%= menu.name %></h3>
                <a href="/admin/menu/<%= menu._id %>/edit" class="edit-icon">
                  <i class="fa-solid fa-pen"></i>
                </a>
              </div>
              <p class="price"><%= menu.price.toLocaleString() %>원</p>
              <p class="description"><%= menu.description || '설명 없음' %></p>
              <p class="status <%= menu.isActive? 'on':'off' %>"><%= menu.isActive? '판매중':'품절' %></p>
            </div>
            <% }) %>
          </div>
        </section>
        <% }) %>
      </div>
    </div>
    <!-- 신규 추가 플로팅 버튼 -->
    <form action="/admin/menu/new" class="fab-container">
      <button class="fab">+</button>
    </form>

    <script src="/toast.js"></script>
    <script>
      const categoryBar = document.querySelector(".category-tabs");
      const buttons = document.querySelectorAll(".tab-btn");
      const sections = document.querySelectorAll(".category-section");

      let autoScrollInProgress = false;
      let autoScrollTimeout;

      // 1) 버튼 클릭 → 즉시 active 설정 & 자동 스크롤 플래그 토글
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          // (a) 클릭 즉시 active
          buttons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          // (b) 자동 스크롤 시작
          const targetId = btn.dataset.target;
          const targetSection = document.getElementById(targetId);
          if (!targetSection) return;

          const yOffset = -categoryBar.offsetHeight - 50; // navBar 50px
          const y = targetSection.getBoundingClientRect().top + window.pageYOffset + yOffset;

          // 플래그 올리고, 이전 타이머 지운 뒤 스크롤
          autoScrollInProgress = true;
          clearTimeout(autoScrollTimeout);
          window.scrollTo({ top: y, behavior: "smooth" });

          // 500ms 후 자동 스크롤 끝난 걸로 간주
          autoScrollTimeout = setTimeout(() => {
            autoScrollInProgress = false;
          }, 500);
        });

        // 2) 스크롤 감지 → 자동 스크롤 중이면 무시, 아니면 섹션 기준 active 토글
        window.addEventListener("scroll", () => {
          if (autoScrollInProgress) return;

          let currentSectionId = "";
          const scrollY = window.scrollY;

          sections.forEach((section) => {
            const sectionTop = section.offsetTop - categoryBar.offsetHeight - 10;
            const sectionBottom = sectionTop + section.offsetHeight;
            if (scrollY >= sectionTop && scrollY < sectionBottom) {
              currentSectionId = section.id;
            }
          });

          buttons.forEach((btn) => {
            btn.dataset.target === currentSectionId ? btn.classList.add("active") : btn.classList.remove("active");
          });
        });
      });

      // 메뉴 삭제
      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (!confirm("메뉴를 삭제하시겠습니까?")) return;
          const id = btn.dataset.id;
          const res = await fetch(`/admin/menu/${id}`, { method: "DELETE" });
          if (res.ok) btn.closest(".menu-card").remove();
          else {
            const msg = await res.text();
            showToast(msg);
          }
        });
      });
    </script>
  </body>
</html>
