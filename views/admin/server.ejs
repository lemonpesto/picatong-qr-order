<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í”¼ì¹´í†µ ì˜¤ë”</title>
    <link rel="stylesheet" href="/admin.css" />
    <script src="https://kit.fontawesome.com/a3ff865f92.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <%- include('./partial/sidebar') %>

    <div class="server-page">
      <!-- <h1>ì„œë²„ í˜ì´ì§€</h1> -->

      <div class="server-tabs">
        <button id="tab-paid" class="active">ì†¡ê¸ˆ í™•ì¸</button>
        <button id="tab-serve">ì„œë¹™</button>
      </div>

      <!-- í…Œì´ë¸” í•„í„° -->
      <div class="table-filter">
        <button class="filter-btn active" data-table="all">ì „ì²´</button>
        <% for(let i=1; i<=tableNum; i++){ %>
        <button class="filter-btn" data-table="<%= i %>">T<%= i %></button>
        <% }%>
      </div>

      <!-- ì†¡ê¸ˆ í™•ì¸ ëª©ë¡ -->
      <div id="paid-list" class="order-list">
        <% unpaidOrders.forEach(order => { %>
        <div class="order-card" data-table="<%= order.tableNum %>" data-id="<%= order._id %>">
          <div class="order-header">
            <div class="left-header">
              <span class="table-num">T<%= order.tableNum %></span>
              <span class="time"
                ><%= new Date(order.requestedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %></span
              >
            </div>
            <button type="submit" class="btn-delete">ì‚­ì œ</button>
          </div>
          <div class="order-items">
            <p class="items-list collapsed"><%= order.items.map(i => `${i.menuName} x${i.qty}`).join(', ') %></p>
          </div>
          <div class="paid-order-footer">
            <span class="order-total"><%= order.total.toLocaleString() %>ì›</span>
            <button type="submit" class="btn-confirm-payment">ì†¡ê¸ˆí™•ì¸</button>
          </div>
        </div>
        <% }) %>
        <div id="paid-notice" class="inline-action <%= unpaidOrders.length > 0 ? 'hidden' : '' %>">
          <p>ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
      </div>

      <!-- ì„œë¹™ ëª©ë¡ -->
      <div id="serve-list" class="order-list hidden">
        <% serveOrders.forEach(order => { %>
        <div class="order-card" data-table="<%= order.tableNum %>" data-order-id="<%= order._id %>">
          <div class="order-header">
            <div class="left-header">
              <span class="table-num">T<%= order.tableNum %></span>
              <span class="time"
                ><%= new Date(order.requestedAt).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) %></span
              >
            </div>
          </div>
          <div class="order-items">
            <ul>
              <% order.items.forEach(item => { %>
              <li data-menu-id="<%= item.menuId %>">
                <label>
                  <input type="checkbox" class="serve-checkbox" <%- (!item.manufacturing || item.cooked) ? '' : 'disabled' %> />
                  <span class="item-text"><%= item.menuName %> x<%= item.qty %> </span>
                </label>
              </li>
              <% }) %>
            </ul>
          </div>
          <div class="serve-order-footer">
            <input type="button" class="btn-serve-complete" value="ì„œë¹™ì™„ë£Œ" <%= order.items.every(i => !i.manufacturing || i.cooked) ? '' :
            'disabled' %> />
          </div>
        </div>
        <% }) %>
        <div id="serve-notice" class="inline-action <%= serveOrders.length > 0 ? 'hidden' : '' %>">
          <p>ì„œë¹™í•  ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
      </div>
    </div>
    <div id="toast" class="toast-msg"></div>
    <script src="/toast.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      (function () {
        const socket = io();
        const tabs = { paid: '#tab-paid', serve: '#tab-serve' };
        const lists = { paid: '#paid-list', serve: '#serve-list' };
        const notices = { paid: '#paid-notice', serve: '#serve-notice' };
        const filterBtns = '.filter-btn';

        // --- ìš”ì†Œ ì°¸ì¡° ---
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));
        const paidTab = $(tabs.paid),
          serveTab = $(tabs.serve);
        const paidList = $(lists.paid),
          serveList = $(lists.serve);
        const paidNotice = $(notices.paid),
          serveNotice = $(notices.serve);

        // --- íƒ­ ì „í™˜ ---
        function showTab(type) {
          paidTab.classList.toggle('active', type === 'paid');
          serveTab.classList.toggle('active', type === 'serve');
          paidList.classList.toggle('hidden', type !== 'paid');
          serveList.classList.toggle('hidden', type !== 'serve');
        }
        paidTab.addEventListener('click', () => showTab('paid'));
        serveTab.addEventListener('click', () => showTab('serve'));

        // --- ê³µì§€ ì—…ë°ì´íŠ¸ ---
        function updateNotices() {
          paidNotice.classList.toggle('hidden', paidList.querySelectorAll('.order-card').length);
          serveNotice.classList.toggle('hidden', serveList.querySelectorAll('.order-card').length);
        }

        // --- ê³µí†µ ì•¡ì…˜ í•¸ë“¤ëŸ¬ ---
        async function handleAction(url, card, queryKey = 'id') {
          try {
            const id = card.dataset[queryKey];
            const res = await fetch(`${url}?${queryKey}=${id}`, { method: 'POST' });
            const msg = await res.text();
            showToast(msg);
            card.remove();
            updateNotices();
          } catch {
            showToast('ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          }
        }

        // --- ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„: ì†¡ê¸ˆí™•ì¸ & ì‚­ì œ ---
        paidList.addEventListener('click', (e) => {
          const card = e.target.closest('.order-card');
          if (!card) return;
          if (e.target.matches('.btn-confirm-payment')) handleAction('/admin/server/confirm', card);
          if (e.target.matches('.btn-delete') && confirm('ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) handleAction('/admin/server/delete', card);
        });

        // --- ë²„íŠ¼ ì´ë²¤íŠ¸ ìœ„ì„: ì„œë¹™ì™„ë£Œ ---
        serveList.addEventListener('click', (e) => {
          const card = e.target.closest('.order-card');
          if (e.target.matches('.btn-serve-complete')) handleAction('/admin/server/serve-order', card, 'orderId');
        });

        // --- í…Œì´ë¸” í•„í„°ë§ ---
        let selectedTables = new Set();
        $$(filterBtns).forEach((btn) => {
          btn.addEventListener('click', () => {
            const table = btn.dataset.table;
            if (table === 'all') {
              selectedTables.clear();
              $$(filterBtns).forEach((b) => b.classList.remove('active'));
              btn.classList.add('active');
            } else {
              document.querySelector('[data-table="all"]').classList.remove('active');
              btn.classList.toggle('active');
              selectedTables.has(table) ? selectedTables.delete(table) : selectedTables.add(table);
            }
            $$('.order-card').forEach((card) => {
              card.style.display = selectedTables.size === 0 || selectedTables.has(card.dataset.table) ? '' : 'none';
            });
          });
        });

        // --- Socket.IO ì—°ê²° & ì´ˆê¸°í™” ---
        socket.on('connect', () => {
          serveList.querySelectorAll('.order-card').forEach((card) => {
            socket.emit('joinOrderRoom', card.dataset.orderId);
          });
          updateNotices();
        });

        // --- ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìˆ˜ì‹  & ì¹´ë“œ ìƒì„± ---
        socket.on('newOrder', (order) => {
          console.log('ğŸ› Received newOrder', order._id);
          paidList.prepend(createPaidCard(order));
          updateNotices();
        });

        socket.on('orderPaid', (order) => {
          serveList.prepend(createServeCard(order));
          socket.emit('joinOrderRoom', order._id);
          updateNotices();
        });

        socket.on('itemCooked', ({ orderId, menuId }) => {
          const card = serveList.querySelector(`[data-order-id="${orderId}"]`);
          if (!card) return;
          const chk = card.querySelector(`li[data-menu-id="${menuId}"] .serve-checkbox`);
          chk.disabled = false;
          if ([...card.querySelectorAll('.serve-checkbox')].every((c) => !c.disabled)) card.querySelector('.btn-serve-complete').disabled = false;
        });

        socket.on('itemUncooked', ({ orderId, menuId }) => {
          const card = serveList.querySelector(`[data-order-id="${orderId}"]`);
          if (!card) return;
          const chk = card.querySelector(`li[data-menu-id="${menuId}"] .serve-checkbox`);
          chk.disabled = true;
          chk.checked = false;
          card.querySelector('.btn-serve-complete').disabled = true;
        });

        socket.on('orderCooked', (orderId) => {
          const card = serveList.querySelector(`[data-order-id="${orderId}"]`);
          if (!card) return;
          card.querySelectorAll('.serve-checkbox').forEach((c) => (c.disabled = false));
          card.querySelector('.btn-serve-complete').disabled = false;
        });

        // --- ì¹´ë“œ ìƒì„± í•¨ìˆ˜ë“¤ ---
        function createPaidCard(o) {
          const c = document.createElement('div');
          c.className = 'order-card';
          c.dataset.table = o.tableNum;
          c.dataset.id = o._id;
          c.innerHTML = `
          <div class="order-header">
            <div class="left-header">
              <span class="table-num">T${o.tableNum}</span>
              <span class="time">${new Date(o.requestedAt).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
              })}</span>
              
            </div>
            <button class="btn-delete">ì‚­ì œ</button>
          </div>
          <div class="order-items">
            <p class="items-list collapsed">
              ${o.items.map((i) => `${i.menuName} x${i.qty}`).join(', ')}
            </p>
          </div>
          <div class="paid-order-footer">
            <span class="order-total">${o.total.toLocaleString()}ì›</span>
            <button class="btn-confirm-payment">ì†¡ê¸ˆí™•ì¸</button>
          </div>`;
          return c;
        }

        function createServeCard(o) {
          const c = document.createElement('div');
          c.className = 'order-card';
          c.dataset.table = o.tableNum;
          c.dataset.orderId = o._id;
          c.innerHTML = `
          <div class="order-header">
            <div class="left-header">
            <span class="table-num">T${o.tableNum}</span>
            <span class="time">${new Date(o.requestedAt).toLocaleTimeString('ko-KR', {
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
            })}</span>
            </div>
          </div>
          <div class="order-items">
            <ul>
              ${o.items
                .map(
                  (item) => `
                <li data-menu-id="${item.menuId}">
                  <label>
                    <input type="checkbox" class="serve-checkbox"
                      ${!item.manufacturing ? '' : 'disabled'} />
                    <span class="item-text">${item.menuName} x${item.qty}</span>
                  </label>
                </li>`
                )
                .join('')}
            </ul>
          </div>
          <div class="serve-order-footer">
            <input type="button" class="btn-serve-complete" value="ì„œë¹™ì™„ë£Œ"
              ${o.items.every((i) => !i.manufacturing || i.cooked) ? '' : 'disabled'} />
          </div>`;
          return c;
        }
      })();
    </script>
  </body>
</html>
