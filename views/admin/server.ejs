<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í”¼ì¹´í†µ í˜¸í”„ ê´€ë¦¬</title>
    <link rel="stylesheet" href="/admin.css" />
    <script src="https://kit.fontawesome.com/a3ff865f92.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <!-- /views/admin/server.ejs -->

    <%- include('./partial/sidebar') %>

    <div class="server-page">
      <!-- <h1>ì„œë²„ í˜ì´ì§€</h1> -->

      <div class="server-tabs">
        <button id="tab-paid" class="active">ì†¡ê¸ˆ í™•ì¸</button>
        <button id="tab-serve">ì„œë¹™</button>
      </div>

      <!-- í…Œì´ë¸” í•„í„° -->
      <div class="table-filter">
        <button class="filter-btn active" data-table="all">ì „ì²´</button>
        <% for(let i=1; i<=tableNum; i++){ %>
        <button class="filter-btn" data-table="<%= i %>">T<%= i %></button>
        <% }%>
      </div>

      <!-- ì†¡ê¸ˆ í™•ì¸ ëª©ë¡ -->
      <div id="paid-list" class="order-list">
        <% unpaidOrders.forEach(order => { %>
        <div class="order-card" data-table="<%= order.tableNum %>" data-id="<%= order._id %>">
          <div class="order-header">
            <span>T<%= order.tableNum %></span>
            <span><%= order.requestedAt.toLocaleString() %></span>
            <button type="submit" class="btn-delete">ì‚­ì œ</button>
          </div>
          <div class="order-items">
            <p class="items-list collapsed"><%= order.items.map(i => `${i.menuName} x${i.qty}`).join(', ') %></p>
          </div>
          <div class="order-footer">
            <span class="order-total"><%= order.total.toLocaleString() %>ì›</span>
            <button type="submit" class="btn-confirm-payment">ì†¡ê¸ˆ í™•ì¸</button>
          </div>
        </div>
        <% }) %>
        <div class="notice-bar <%= unpaidOrders.length > 0 ? 'hidden' : '' %>">
          <p>ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
      </div>

      <!-- ì„œë¹™ ëª©ë¡ -->
      <div id="serve-list" class="order-list hidden">
        <% serveOrders.forEach(order => { %>
        <div class="order-card" data-table="<%= order.tableNum %>" data-order-id="<%= order._id %>">
          <div class="order-header">
            <span>T<%= order.tableNum %></span>
            <span><%= new Date(order.requestedAt).toLocaleString() %></span>
          </div>
          <div class="order-items">
            <ul>
              <% order.items.forEach(item => { %>
              <li data-menu-id="<%= item.menuId %>">
                <label>
                  <input type="checkbox" class="serve-checkbox" <%- (!item.manufacturing || item.cooked) ? '' : 'disabled' %> /> <%= item.menuName %>
                  x<%= item.qty %>
                </label>
              </li>
              <% }) %>
            </ul>
          </div>
          <div class="order-footer">
            <input type="button" class="btn-serve-complete" value="ì„œë¹™ì™„ë£Œ" <%= order.items.every(i => !i.manufacturing || i.cooked) ? '' :
            'disabled' %> />
          </div>
        </div>
        <% }) %>
        <div class="notice-bar <%= serveOrders.length > 0 ? 'hidden' : '' %>">
          <p>ì„œë¹™í•  ìŒì‹ì´ ì—†ìŠµë‹ˆë‹¤</p>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // --- íƒ­ ì „í™˜ ---
      const paidTab = document.getElementById('tab-paid');
      const serveTab = document.getElementById('tab-serve');
      const paidList = document.getElementById('paid-list');
      const serveList = document.getElementById('serve-list');

      paidTab.addEventListener('click', () => {
        paidTab.classList.add('active');
        serveTab.classList.remove('active');
        paidList.classList.remove('hidden');
        serveList.classList.add('hidden');
      });
      serveTab.addEventListener('click', () => {
        serveTab.classList.add('active');
        paidTab.classList.remove('active');
        serveList.classList.remove('hidden');
        paidList.classList.add('hidden');
      });

      // --- í…Œì´ë¸” í•„í„° ---
      const filterButtons = Array.from(document.querySelectorAll('.filter-btn'));
      const allBtn = filterButtons.find((b) => b.dataset.table === 'all');
      let selectedTables = new Set();

      filterButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          const table = btn.dataset.table;
          if (table === 'all') {
            filterButtons.forEach((b) => b.classList.remove('active'));
            allBtn.classList.add('active');
            selectedTables.clear();
            document.querySelectorAll('.order-card').forEach((card) => {
              card.style.display = '';
            });
          } else {
            allBtn.classList.remove('active');
            if (selectedTables.has(table)) {
              selectedTables.delete(table);
              btn.classList.remove('active');
            } else {
              selectedTables.add(table);
              btn.classList.add('active');
            }
            document.querySelectorAll('.order-card').forEach((card) => {
              card.style.display = selectedTables.has(card.dataset.table) ? '' : 'none';
            });
          }
        });
      });

      // --- ì†¡ê¸ˆ í™•ì¸ & ì£¼ë¬¸ ì·¨ì†Œ ---
      document.querySelectorAll('.btn-confirm-payment').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const card = btn.closest('.order-card');
          const id = card.dataset.id;
          try {
            const res = await fetch(`/admin/server/confirm?id=${id}`, {
              method: 'POST',
            });
            alert(await res.text());
            card.remove();
          } catch {
            alert('ì†¡ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
          }
        });
      });
      document.querySelectorAll('.btn-delete').forEach((btn) => {
        btn.addEventListener('click', async () => {
          if (!confirm('ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
          const card = btn.closest('.order-card');
          const id = card.dataset.id;
          try {
            const res = await fetch(`/admin/server/delete?id=${id}`, {
              method: 'POST',
            });
            alert(await res.text());
            card.remove();
          } catch {
            alert('ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ');
          }
        });
      });

      // --- Socket.io & ì‹¤ì‹œê°„ ì„œë¹™ í™œì„±í™” ---
      document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        socket.on('connect', () => {
          console.log('ğŸ”Œ Socket connected:', socket.id);
          document.querySelectorAll('#serve-list .order-card').forEach((card) => {
            const orderId = card.dataset.orderId;
            console.log('â¡ï¸ joinOrderRoom:', orderId);
            socket.emit('joinOrderRoom', orderId);
          });
        });
        // ğŸ”” ìƒˆ ì£¼ë¬¸ ë„ì°©í–ˆì„ ë•Œ
        socket.on('newOrder', (order) => {
          console.log('ğŸ“¬ newOrder:', order);

          // 1) ì¹´ë“œ DOM ìƒì„±
          const card = document.createElement('div');
          card.className = 'order-card';
          card.dataset.table = order.tableNum;
          card.dataset.id = order._id;

          card.innerHTML = `
            <div class="order-header">
              <span>í…Œì´ë¸”${order.tableNum}</span>
              <span>${new Date(order.requestedAt).toLocaleString()}</span>
              <button class="btn-delete">ì‚­ì œ</button>
            </div>
            <div class="order-items">
              <p class="items-list collapsed">
                ${order.items.map((i) => `${i.menuName} x${i.qty}`).join(', ')}
              </p>
            </div>
            <div class="order-footer">
              <span class="order-total">${order.total.toLocaleString()}ì›</span>
              <button class="btn-confirm-payment">ì†¡ê¸ˆ í™•ì¸</button>
            </div>
          `;

          // 2) ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë°”ì¸ë”©
          const btnConfirm = card.querySelector('.btn-confirm-payment');
          btnConfirm.addEventListener('click', async () => {
            try {
              const res = await fetch(`/admin/server/confirm?id=${order._id}`, { method: 'POST' });
              alert(await res.text());
              card.remove();
            } catch {
              alert('ì†¡ê¸ˆ í™•ì¸ ì¤‘ ì˜¤ë¥˜');
            }
          });
          const btnDelete = card.querySelector('.btn-delete');
          btnDelete.addEventListener('click', async () => {
            if (!confirm('ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            try {
              const res = await fetch(`/admin/server/delete?id=${order._id}`, { method: 'POST' });
              alert(await res.text());
              card.remove();
            } catch {
              alert('ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜');
            }
          });

          // 3) ë¦¬ìŠ¤íŠ¸ ë§¨ ìœ„ì— ì¶”ê°€ (ìµœì‹  ì£¼ë¬¸ì´ ìœ„ë¡œ)
          paidList.prepend(card);
        });
        // â–¶ï¸ ê²°ì œ ì™„ë£Œ ìƒˆ ì£¼ë¬¸ì´ ë“¤ì–´ì™”ì„ ë•Œ
        socket.on('orderPaid', (order) => {
          console.log('ğŸ’° orderPaid ì´ë²¤íŠ¸:', order);
          // 1) ì¹´ë“œ HTML ìƒì„±
          const cardHtml = `
            <div class="order-card" data-table="${order.tableNum}" data-order-id="${order._id}">
              <div class="order-header">
                <span>T${order.tableNum}</span>
                <span>${new Date(order.requestedAt).toLocaleString()}</span>
              </div>
              <div class="order-items">
                <ul>
                  ${order.items
                    .map(
                      (item) => `
                    <li data-menu-id="${item.menuId}">
                      <label>
                        <input
                          type="checkbox"
                          class="serve-checkbox"
                          ${item.manufacturing || item.cooked ? '' : 'disabled'}
                          ${item.cooked ? 'checked' : ''}
                        />
                        ${item.menuName} x${item.qty}
                      </label>
                    </li>`
                    )
                    .join('')}
                </ul>
              </div>
              <div class="order-footer">
                <button
                  class="btn-serve-complete"
                  ${order.items.every((i) => i.manufacturing || i.cooked) ? '' : 'disabled'}
                >ì„œë¹™ì™„ë£Œ</button>
              </div>
            </div>`;
          // 2) ì„œë¹™ ë¦¬ìŠ¤íŠ¸ì— prepend
          serveList.insertAdjacentHTML('afterbegin', cardHtml);

          // 3) ë°©(join) ë° ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
          const newCard = serveList.querySelector(`.order-card[data-order-id="${order._id}"]`);
          socket.emit('joinOrderRoom', order._id);

          newCard.querySelector('.btn-serve-complete').addEventListener('click', async () => {
            await fetch('/admin/server/serve-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderId: order._id }),
            });
            newCard.remove();
          });
        });
        // ì£¼ë°©ì—ì„œ ì¡°ë¦¬ ì²´í¬ ì‹œ ì„œë²„ í˜ì´ì§€ ì²´í¬ë°•ìŠ¤ í™œì„±í™”
        socket.on('itemCooked', ({ orderId, menuId }) => {
          const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
          if (!card) return;
          const li = card.querySelector(`li[data-menu-id="${menuId}"]`);
          const chk = li.querySelector('input.serve-checkbox');
          chk.disabled = false;
          // ëª¨ë‘ í™œì„±í™”ë˜ì—ˆëŠ”ì§€ ê²€ì‚¬í•´ì„œ ë²„íŠ¼ ì¼œê¸°
          const allEnabled = [...card.querySelectorAll('input.serve-checkbox')].every((i) => !i.disabled);
          if (allEnabled) {
            card.querySelector('.btn-serve-complete').disabled = false;
          }
        });

        // (2) ê°œë³„ ë©”ë‰´ ì¡°ë¦¬ ì·¨ì†Œ â†’ ë¹„í™œì„±í™”
        socket.on('itemUncooked', ({ orderId, menuId }) => {
          const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
          if (!card) return;
          const chk = card.querySelector(`li[data-menu-id="${menuId}"] .serve-checkbox`);
          chk.disabled = true;
          chk.checked = false;
          // í•˜ë‚˜ë¼ë„ disabledë©´ ì„œë¹™ì™„ë£Œ ë²„íŠ¼ ë¹„í™œì„±í™”
          card.querySelector('.btn-serve-complete').disabled = true;
        });

        // (3) ì „ì²´ ìš”ë¦¬ ì™„ë£Œ â†’ ëª¨ë“  ë©”ë‰´ ì²´í¬Â·í™œì„±í™”
        socket.on('orderCooked', (orderId) => {
          const card = document.querySelector(`.order-card[data-order-id="${orderId}"]`);
          if (!card) return;
          card.querySelectorAll('.serve-checkbox').forEach((chk) => {
            chk.disabled = false;
          });
          // ì„œë¹™ì™„ë£Œ ë²„íŠ¼ë„ í™œì„±í™”
          card.querySelector('.btn-serve-complete').disabled = false;
        });

        // ì„œë¹™ì™„ë£Œ ë²„íŠ¼ í´ë¦­ â†’ ì„œë²„ API í˜¸ì¶œ + ì¹´ë“œ ì œê±°
        document.querySelectorAll('.btn-serve-complete').forEach((btn) => {
          btn.addEventListener('click', async (e) => {
            const card = e.target.closest('.order-card');
            const orderId = card.dataset.orderId;
            await fetch('/admin/server/serve-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderId }),
            });
            card.remove();
          });
        });
      });
    </script>
  </body>
</html>
